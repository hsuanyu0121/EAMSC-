<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P!LOT | Student Navigator</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap');
        body { background-color: #FFFDF9; font-family: 'Inter', sans-serif; display: flex; height: 100vh; overflow: hidden; color: #4A443F; }
        .column { height: 100vh; overflow-y: auto; padding: 2rem; border-right: 1px solid #E5E1DA; }
        .glass-card { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(10px); border-radius: 24px; border: 1px solid rgba(229, 225, 218, 0.5); }
        .chat-bubble { max-width: 85%; padding: 1rem; border-radius: 20px; margin-bottom: 12px; font-size: 14px; line-height: 1.6; }
        .ai-bubble { background: #F0EBE3; align-self: flex-start; border-bottom-left-radius: 4px; }
        .user-bubble { background: #6B8E23; color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>
    <aside class="column w-1/4 bg-[#F5F2ED] flex flex-shrink-0 flex-col">
        <h1 class="text-4xl font-black italic text-[#6B8E23] mb-8">P!LOT</h1>
        <div id="authArea" class="mb-6">
            <button onclick="signIn()" class="w-full py-3 bg-white rounded-xl shadow-sm font-bold text-slate-600 hover:shadow-md transition">Sign in with Google</button>
            <div id="userInfo" class="hidden flex items-center gap-3 p-4 glass-card">
                <img id="userAvatar" class="w-10 h-10 rounded-full border-2 border-white shadow-sm" src="">
                <p id="userName" class="text-sm font-bold truncate"></p>
            </div>
        </div>
        <div class="p-4 glass-card border-2 border-dashed border-[#6B8E23]/30 mb-6">
            <p class="text-[10px] font-black opacity-40 mb-3 uppercase tracking-widest">üîê AI Key Setting</p>
            <a href="https://aistudio.google.com/app/apikey" target="_blank" class="block w-full mb-3 py-2 bg-blue-50 text-blue-600 text-center text-[10px] font-bold rounded-lg border border-blue-200 hover:bg-blue-100 transition">1. Get Free API Key</a>
            <input id="userApiKey" type="password" class="w-full p-2 text-xs rounded-lg border outline-none focus:ring-1 focus:ring-[#6B8E23]" placeholder="2. Paste Key Here">
            <button onclick="saveUserKey()" class="w-full mt-2 py-2 bg-slate-800 text-white text-[10px] rounded-lg font-bold">Activate AI</button>
            <p id="keyStatus" class="text-[9px] mt-2 italic text-slate-400">Status: Waiting for Key</p>
        </div>
        <nav class="space-y-2 flex-1">
            <button onclick="switchTab('ai')" class="w-full text-left px-5 py-3 rounded-xl font-bold text-sm bg-white shadow-sm text-[#6B8E23]">ü§ñ AI Counseling</button>
            <button onclick="switchTab('social')" class="w-full text-left px-5 py-3 rounded-xl font-bold text-sm hover:bg-white/50 transition">üçÉ Social Square</button>
        </nav>
    </aside>

    <main class="flex-1 column bg-[#FFFDF9] flex flex-col relative">
        <div id="ai-tab" class="h-full flex flex-col">
            <div id="chatWindow" class="flex-1 overflow-y-auto flex flex-col scrollbar-hide mb-6 pr-2">
                <div class="chat-bubble ai-bubble italic">Hello. I am P!LOT. Please ensure your API Key is set to start.</div>
            </div>
            <div class="relative flex gap-2">
                <input id="chatInput" type="text" class="flex-1 p-5 glass-card shadow-2xl outline-none" placeholder="Message P!LOT...">
                <button onclick="sendMessage()" class="px-8 bg-[#6B8E23] text-white rounded-[2rem] font-bold">Send</button>
            </div>
        </div>
        <div id="social-tab" class="h-full flex flex-col hidden">
            <textarea id="postInput" class="w-full p-6 glass-card text-sm mb-4 outline-none border-none" rows="4" placeholder="How are you feeling?"></textarea>
            <button onclick="createPost()" class="self-end px-10 py-3 bg-[#6B8E23] text-white rounded-full font-bold text-xs shadow-lg">Post</button>
            <div id="socialFeed" class="mt-8 space-y-4 overflow-y-auto scrollbar-hide"></div>
        </div>
    </main>

    <aside class="column w-1/4 bg-white flex-shrink-0 text-center">
        <h4 class="text-[10px] font-black opacity-30 uppercase tracking-[0.3em] mb-12">RL Metrics</h4>
        <div class="space-y-8">
            <div class="p-8 bg-slate-50 rounded-[2.5rem] border border-slate-100 shadow-inner">
                <p class="text-[10px] font-bold text-blue-500 mb-2 uppercase">Anxiety Indicator</p>
                <p id="stat-anxiety" class="text-5xl font-black text-blue-600">0.0%</p>
            </div>
            <div class="p-8 bg-slate-50 rounded-[2.5rem] border border-slate-100 shadow-inner">
                <p class="text-[10px] font-bold text-[#6B8E23] mb-2 uppercase">Cumulative Reward</p>
                <p id="stat-reward" class="text-5xl font-black text-[#6B8E23]">500</p>
            </div>
        </div>
    </aside>

    <script>
        const firebaseConfig = {  apiKey: "AIzaSyCYXhTT_MzhE6K2OE6HuAx9kwEZlIKbZMg",
          authDomain: "eamsc-929aa.firebaseapp.com",
          projectId: "eamsc-929aa",
          storageBucket: "eamsc-929aa.firebasestorage.app",
          messagingSenderId: "1010678005753",
          appId: "1:1010678005753:web:6283391cec141c7e664728",
          measurementId: "G-TQ48PSK5H4"};
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth(), db = firebase.firestore();
        let geminiKey = localStorage.getItem('p!lot_key') || "", rlStats = { anxiety: 0, reward: 500 };

        function signIn() { auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); }
        function saveUserKey() { 
            const k = document.getElementById('userApiKey').value.trim();
            if(k.startsWith("AIza")) { localStorage.setItem('p!lot_key', k); geminiKey = k; updateKeyUI(); alert("Success!"); }
        }
        function updateKeyUI() { if(geminiKey) { document.getElementById('keyStatus').innerText = "‚óè Service Active"; document.getElementById('keyStatus').className="text-[9px] mt-2 text-green-600 font-bold"; } }
        updateKeyUI();

        auth.onAuthStateChanged(u => { if(u) { document.getElementById('authArea').classList.add('hidden'); document.getElementById('userInfo').classList.remove('hidden'); document.getElementById('userName').innerText = u.displayName; document.getElementById('userAvatar').src = u.photoURL; loadPosts(); } });

        async function sendMessage() {
            const input = document.getElementById('chatInput'), msg = input.value.trim();
            if(!msg || !geminiKey) return; appendBubble(msg, 'user'); input.value = "";
            rlStats.anxiety += (Math.random() * 2 - 1);
            document.getElementById('stat-anxiety').innerText = rlStats.anxiety.toFixed(1) + "%";
            
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${geminiKey}`, {
                    method: "POST", headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ contents: [{ parts: [{ text: `You are a counselor. User anxiety: ${rlStats.anxiety}%. Respond warmly to: ${msg}` }] }] })
                });
                const data = await res.json();
                appendBubble(data.candidates[0].content.parts[0].text, 'ai');
                syncToAdmin(msg, "AI");
            } catch (e) { appendBubble("Connection Error.", 'ai'); }
        }

        function appendBubble(t, r) { const d = document.createElement('div'); d.className = `chat-bubble ${r}-bubble`; d.innerText = t; const w = document.getElementById('chatWindow'); w.appendChild(d); w.scrollTop = w.scrollHeight; }
        function switchTab(t) { document.getElementById('ai-tab').classList.toggle('hidden', t !== 'ai'); document.getElementById('social-tab').classList.toggle('hidden', t !== 'social'); }
        
        function createPost() {
            const t = document.getElementById('postInput').value.trim(); if(!t) return;
            db.collection("posts").add({ uid: auth.currentUser.uid, userName: auth.currentUser.displayName, userAvatar: auth.currentUser.photoURL, content: t, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
            document.getElementById('postInput').value = ""; syncToAdmin(t, "Social");
        }

        function loadPosts() {
            db.collection("posts").orderBy("timestamp", "desc").onSnapshot(snap => {
                const f = document.getElementById('socialFeed'); f.innerHTML = "";
                snap.forEach(doc => { const d = doc.data(); f.innerHTML += `<div class="p-6 bg-white rounded-3xl border shadow-sm mb-4"><div class="flex items-center gap-2 mb-2"><img src="${d.userAvatar}" class="w-6 h-6 rounded-full"><span class="font-bold text-xs">${d.userName}</span></div><p class="text-sm text-slate-500">${d.content}</p></div>`; });
            });
        }

        function syncToAdmin(m, type) {
            db.collection("monitor_center").doc(auth.currentUser.uid).set({
                uid: auth.currentUser.uid, userName: auth.currentUser.displayName, userAvatar: auth.currentUser.photoURL,
                anxiety_reduction: rlStats.anxiety.toFixed(1), cumulative_reward: rlStats.reward.toFixed(1),
                last_msg: m, msg_type: type, timestamp: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true });
        }
    </script>
</body>
</html>
