<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P!LOT | å­¸ç”Ÿç«¯ AI å¿ƒç†å°èˆª</title>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;700&display=swap');
        :root { --warm-bg: #FFFDF9; --accent-green: #6B8E23; }
        body { background-color: var(--warm-bg); font-family: 'Noto Sans TC', sans-serif; height: 100vh; overflow: hidden; display: flex; }
        .column { height: 100vh; overflow-y: auto; padding: 2rem; border-right: 1px solid #E5E1DA; }
        .glass-card { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(10px); border-radius: 24px; border: 1px solid rgba(229, 225, 218, 0.5); }
        .chat-bubble { max-width: 85%; padding: 1rem 1.5rem; border-radius: 20px; margin-bottom: 1rem; font-size: 15px; line-height: 1.6; }
        .ai-bubble { background: #F0EBE3; align-self: flex-start; border-bottom-left-radius: 4px; }
        .user-bubble { background: var(--accent-green); color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
        /* éš±è—æ²è»¸ */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="flex w-full">

    <aside class="column w-1/4 bg-[#F5F2ED]">
        <div class="mb-10 text-center">
            <h1 class="text-3xl font-black italic tracking-tighter text-[#6B8E23]">P!LOT</h1>
            <p class="text-[10px] opacity-40 uppercase font-bold tracking-widest mt-1">Mental Health Navigator</p>
        </div>

        <div id="authArea" class="mb-8">
            <button id="loginBtn" onclick="signIn()" class="w-full py-4 glass-card font-black text-slate-600 hover:bg-white transition active:scale-95 shadow-sm">Google ç™»å…¥</button>
            <div id="userInfo" class="hidden flex items-center gap-3 p-4 glass-card">
                <img id="userAvatar" class="w-12 h-12 rounded-full border-2 border-white shadow-sm" src="">
                <div class="overflow-hidden">
                    <p id="userName" class="text-sm font-bold truncate text-slate-700"></p>
                    <button onclick="signOut()" class="text-[10px] text-red-400 font-bold hover:underline">ç™»å‡ºç³»çµ±</button>
                </div>
            </div>
        </div>

        <section class="mt-10">
            <h4 class="text-[11px] font-black mb-4 uppercase tracking-widest text-slate-400">Mood Journal</h4>
            <div class="space-y-4">
                <textarea id="journalInput" class="w-full p-5 glass-card text-sm focus:outline-none focus:ring-2 focus:ring-[#6B8E23]/20 transition" rows="4" placeholder="ä»Šå¤©ç™¼ç”Ÿäº†ä»€éº¼äº‹å—ï¼Ÿ"></textarea>
                <button onclick="saveJournal()" class="w-full py-3 bg-[#6B8E23] text-white rounded-2xl text-xs font-black shadow-lg shadow-[#6B8E23]/20 hover:translate-y-[-2px] transition">ç™¼å¸ƒåˆ°å¿ƒæƒ…ç­†è¨˜</button>
                
                <div id="journalList" class="mt-6 space-y-3 max-h-[300px] overflow-y-auto pr-2 scrollbar-hide">
                    </div>
            </div>
        </section>
    </aside>

    <main class="column flex-1 flex flex-col bg-[#FFFDF9] relative">
        <header class="flex justify-between items-center mb-8">
            <div class="flex items-center gap-3">
                <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
                <h2 class="font-black text-xl italic text-slate-800">AI è«®å•†å°èˆªå“¡</h2>
            </div>
            <div id="rl-indicator" class="px-4 py-1.5 bg-slate-100 rounded-full text-[10px] font-black text-slate-400">
                STRATEGY: <span id="currentStrategy" class="text-[#6B8E23]">INITIALIZING</span>
            </div>
        </header>

        <div id="chatWindow" class="flex-1 flex flex-col overflow-y-auto mb-6 pr-4 scrollbar-hide">
            <div class="chat-bubble ai-bubble">ä½ å¥½ã€‚æˆ‘æ˜¯ä½ çš„å°ˆå±¬ AI å¿ƒç†è«®å•†å¸«ã€‚ä½ å¯ä»¥è·Ÿæˆ‘åˆ†äº«ä»»ä½•å›°æ“¾ï¼Œæˆ‘æœƒä¸€ç›´é™ªè‘—ä½ ã€‚</div>
        </div>

        <div class="relative mt-auto">
            <div class="absolute -top-12 left-0 flex gap-2">
                <button onclick="copyDiagnosis()" class="text-[10px] font-bold text-slate-400 hover:text-[#6B8E23]">ğŸ”— è¤‡è£½å°è©±æ‘˜è¦ (é©ç”¨ NotebookLM)</button>
            </div>
            <input id="chatInput" type="text" class="w-full p-6 glass-card shadow-2xl focus:outline-none text-lg pr-20" placeholder="åœ¨æ­¤è¼¸å…¥è¨Šæ¯...">
            <button id="sendBtn" class="absolute right-6 top-6 text-[#6B8E23] font-black text-xl hover:scale-110 transition">â†µ</button>
        </div>
    </main>

    <script>
        // ======= 1. åˆå§‹åŒ–è¨­å®š =======
        const firebaseConfig = {
             apiKey: "AIzaSyCYXhTT_MzhE6K2OE6HuAx9kwEZlIKbZMg",
             authDomain: "eamsc-929aa.firebaseapp.com",
             projectId: "eamsc-929aa",
             storageBucket: "eamsc-929aa.firebasestorage.app",
             messagingSenderId: "1010678005753",
             appId: "1:1010678005753:web:6283391cec141c7e664728",
             measurementId: "G-TQ48PSK5H4"
        };

        const geminiKey = "AIzaSyCpbz3b2Pgw-FCjdGqYM4LgpqCj7WWrXxQ";

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // å¼·åŒ–å­¸ç¿’ (RL) æ¨¡æ“¬æŒ‡æ¨™
        let rlStats = {
            anxiety: 0,    // ç„¦æ…®æŒ‡æ¨™
            reward: 500,   // ç´¯è¨ˆçå‹µ
            strategy: "Supportive Listening",
            history: []    // å°è©±ç´€éŒ„
        };

        // ======= 2. Google ç™»å…¥é‚è¼¯ =======
        function signIn() {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider).catch(e => alert("ç™»å…¥å¤±æ•—: " + e.message));
        }
        function signOut() { auth.signOut(); }

        auth.onAuthStateChanged(user => {
            if (user) {
                document.getElementById('loginBtn').classList.add('hidden');
                document.getElementById('userInfo').classList.remove('hidden');
                document.getElementById('userName').innerText = user.displayName;
                document.getElementById('userAvatar').src = user.photoURL;
                loadJournals();
            } else {
                document.getElementById('loginBtn').classList.remove('hidden');
                document.getElementById('userInfo').classList.add('hidden');
            }
        });

        // ======= 3. AI è«®å•†æ ¸å¿ƒ (å« RL Prompt) =======
        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const msg = input.value.trim();
            if (!msg || !auth.currentUser) return;

            appendBubble(msg, 'user');
            input.value = "";

            // æ¨¡æ“¬ RL ç‹€æ…‹æ›´æ–° (å¯¦éš›æ‡‰ç”¨ä¸­å¯ç”±æ¨¡å‹åˆ¤æ–·)
            rlStats.anxiety += (Math.random() * 2 - 1); 
            rlStats.strategy = rlStats.anxiety > 3 ? "Crisis Intervention" : "Cognitive Restructuring";
            document.getElementById('currentStrategy').innerText = rlStats.strategy;

            // æ§‹å»ºå°ˆæ¥­ Prompt
            const systemPrompt = `
                ä½ æ˜¯ä¸€ä½çµåˆå¼·åŒ–å­¸ç¿’é‚è¼¯èˆ‡ CBT æŠ€è¡“çš„å°ˆæ¥­è«®å•†å¸«ã€‚
                ã€ç›®å‰å­¸ç”Ÿç‹€æ…‹ã€‘ç„¦æ…®å€¼: ${rlStats.anxiety.toFixed(1)}, å»ºè­°ç­–ç•¥: ${rlStats.strategy}ã€‚
                è«‹é‹ç”¨ ${rlStats.strategy} é€²è¡Œå›è¦†ã€‚èªæ°£æº«æš–ã€å°ˆæ¥­ã€ç°¡ç´„ã€‚
                æœ€å¾Œè«‹åœ¨å›ç­”å¾Œæ›è¡Œä¸¦åŠ ä¸Šä¸€å¥ã€Œ[æ‘˜è¦]ï¼š(ä¸€å¥è©±ç¸½çµæœ¬æ¬¡æ ¸å¿ƒè§€å¿µ)ã€ã€‚
            `;

            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${geminiKey}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: systemPrompt + "\nä½¿ç”¨è€…è¨Šæ¯ï¼š" + msg }] }]
                    })
                });
                const data = await res.json();
                const aiResponse = data.candidates[0].content.parts[0].text;
                appendBubble(aiResponse, 'ai');

                // æ ¸å¿ƒåŒæ­¥ï¼šå°‡æ•¸æ“šæ¨æ’­è‡³ç®¡ç†å“¡å¾Œå° (admin.html)
                syncToAdmin(msg);

                } catch (e) {
                   console.error("è©³ç´°éŒ¯èª¤è³‡è¨Š:", e);
                   appendBubble("éŒ¯èª¤åŸå› ï¼š" + e.message, 'ai');
}

               // appendBubble("æŠ±æ­‰ï¼Œæˆ‘ç¾åœ¨é€£ç·šæœ‰äº›å•é¡Œï¼Œä½†æˆ‘æœƒä¸€ç›´é™ªè‘—ä½ çš„ã€‚", 'ai');
           // }
       // }

        function appendBubble(text, role) {
            const win = document.getElementById('chatWindow');
            const div = document.createElement('div');
            div.className = `chat-bubble ${role}-bubble shadow-sm`;
            div.innerText = text;
            win.appendChild(div);
            win.scrollTop = win.scrollHeight;
        }

        // ======= 4. å¾Œå°æ•¸æ“šåŒæ­¥ =======
        function syncToAdmin(lastMsg) {
            db.collection("monitor_center").doc(auth.currentUser.uid).set({
                uid: auth.currentUser.uid,
                userName: auth.currentUser.displayName,
                userAvatar: auth.currentUser.photoURL,
                anxiety_reduction: rlStats.anxiety.toFixed(1),
                cumulative_reward: rlStats.reward.toFixed(1),
                strategy: rlStats.strategy,
                last_msg: lastMsg,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true });
        }

        // ======= 5. å¿ƒæƒ…è¨˜äº‹æœ¬ =======
        function saveJournal() {
            const text = document.getElementById('journalInput').value;
            if(!text) return;
            db.collection("journals").add({
                uid: auth.currentUser.uid,
                userName: auth.currentUser.displayName,
                text: text,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            }).then(() => {
                document.getElementById('journalInput').value = "";
            });
        }

        function loadJournals() {
            db.collection("journals").orderBy("timestamp", "desc").limit(10).onSnapshot(snap => {
                const list = document.getElementById('journalList');
                list.innerHTML = "";
                snap.forEach(doc => {
                    const d = doc.data();
                    const item = document.createElement('div');
                    item.className = "p-4 glass-card text-xs leading-relaxed shadow-sm";
                    item.innerHTML = `<span class="font-black text-[#6B8E23]">${d.userName}</span><p class="mt-1 text-slate-500">${d.text}</p>`;
                    list.appendChild(item);
                });
            });
        }

        function copyDiagnosis() {
            const chat = document.getElementById('chatWindow').innerText;
            navigator.clipboard.writeText(chat);
            alert("å°è©±ç´€éŒ„å·²è¤‡è£½ï¼Œå¯è²¼å…¥ NotebookLMã€‚");
        }

        document.getElementById('sendBtn').onclick = sendMessage;
    </script>
</body>
</html>
