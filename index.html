<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P!LOT | Mental Navigator</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #FDFCFB; color: #4A443F; }
        .glass-card { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(12px); border-radius: 2rem; border: 1px solid rgba(107, 142, 35, 0.1); }
        .chat-bubble { max-width: 85%; padding: 1rem; border-radius: 1.5rem; margin-bottom: 0.75rem; font-size: 14px; }
        .ai-bubble { background: #F0EBE3; align-self: flex-start; border-bottom-left-radius: 4px; }
        .user-bubble { background: #6B8E23; color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="flex h-screen overflow-hidden">

    <aside class="w-80 bg-[#F5F2ED] p-6 flex flex-col border-r border-slate-200">
        <h1 class="text-4xl font-black italic text-[#6B8E23] mb-10 tracking-tighter">P!LOT</h1>
        
        <div id="authArea" class="mb-8">
            <button onclick="signIn()" class="w-full py-3 bg-white rounded-2xl shadow-sm font-bold text-slate-600">Sign in with Google</button>
            <div id="userInfo" class="hidden flex items-center gap-3 p-3 glass-card">
                <img id="userAvatar" class="w-10 h-10 rounded-full border-2 border-white" src="">
                <span id="userName" class="text-sm font-bold truncate"></span>
            </div>
        </div>

        <div class="p-4 glass-card border-2 border-dashed border-[#6B8E23]/20 mb-8">
            <p class="text-[10px] font-black opacity-40 mb-2 uppercase">üîê AI Service Activation</p>
            <input id="userApiKey" type="password" class="w-full p-2 text-xs rounded-xl border-none outline-none focus:ring-1 focus:ring-[#6B8E23]" placeholder="Paste Gemini API Key">
            <button onclick="saveKey()" class="w-full mt-2 py-2 bg-slate-800 text-white text-[10px] rounded-xl font-bold">Activate P!LOT AI</button>
        </div>

        <nav class="space-y-2 flex-1">
            <button onclick="switchTab('ai')" class="w-full text-left px-5 py-3 rounded-xl font-bold text-sm bg-white shadow-sm text-[#6B8E23]">ü§ñ AI Counseling</button>
            <button onclick="switchTab('social')" class="w-full text-left px-5 py-3 rounded-xl font-bold text-sm hover:bg-white/50 transition">üçÉ Social Square</button>
        </nav>

        <div class="mt-4 p-5 bg-[#A4C639]/10 rounded-3xl border border-[#A4C639]/20">
            <p class="text-[10px] font-black text-[#55721C] uppercase mb-2">‚ú® Today's Mission</p>
            <p id="positiveActivity" class="text-xs font-bold text-slate-600 leading-relaxed italic">Loading activity...</p>
            <button onclick="refreshActivity()" class="mt-3 text-[9px] font-bold text-[#6B8E23] underline">Get New Mission</button>
        </div>
    </aside>

    <main class="flex-1 p-8 flex flex-col relative overflow-hidden bg-white">
        <div id="ai-tab" class="h-full flex flex-col">
            <div id="chatWindow" class="flex-1 overflow-y-auto flex flex-col scrollbar-hide mb-4 pr-4">
                <div class="chat-bubble ai-bubble italic">Hello, I am P!LOT. I am here to listen and guide you. Please ensure your API Key is set to begin our session.</div>
            </div>
            <div class="flex gap-2">
                <input id="chatInput" type="text" class="flex-1 p-5 glass-card shadow-lg outline-none" placeholder="Share your thoughts...">
                <button onclick="sendMessage()" class="px-8 bg-[#6B8E23] text-white rounded-full font-bold shadow-lg transition active:scale-95">Send</button>
            </div>
        </div>

        <div id="social-tab" class="h-full flex flex-col hidden overflow-y-auto scrollbar-hide">
            <h2 class="text-2xl font-black mb-6 italic text-slate-700">Social Square</h2>
            <textarea id="postInput" class="w-full p-6 glass-card text-sm mb-4 outline-none border-none shadow-inner" rows="4" placeholder="Write a message to the community..."></textarea>
            <button onclick="createPost()" class="self-end px-10 py-3 bg-[#6B8E23] text-white rounded-full font-bold text-xs shadow-lg">Post Message</button>
            <div id="socialFeed" class="mt-10 space-y-4"></div>
        </div>
    </main>

    <aside class="w-80 p-8 flex flex-col items-center bg-[#FDFCFB] border-l border-slate-100 shrink-0">
        <h4 class="text-[10px] font-black opacity-30 uppercase tracking-[0.3em] mb-12">Reinforcement Learning</h4>
        <div class="w-full space-y-6">
            <div class="p-6 bg-slate-50 rounded-[2rem] text-center shadow-inner">
                <p class="text-[10px] font-bold text-blue-500 mb-1 uppercase">Award Points</p>
                <p id="stat-award" class="text-4xl font-black text-[#6B8E23]">500</p>
            </div>
            <div class="space-y-4 px-2">
                <div id="m-anxiety"></div>
                <div id="m-stress"></div>
                <div id="m-depression"></div>
                <div id="m-loneliness"></div>
            </div>
        </div>
    </aside>

    <script>
        // ======= Configuration & Initialization =======
        const firebaseConfig = { apiKey: "YOUR_KEY", authDomain: "...", projectId: "...", storageBucket: "...", messagingSenderId: "...", appId: "..." };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore(), auth = firebase.auth();

        let geminiKey = localStorage.getItem('p!lot_key') || "";
        let mentalState = { anxiety: 3, stress: 3, depression: 2, loneliness: 2, award: 500 };
        const activities = ["Have dinner with a friend.", "Take a 10-minute walk in nature.", "Write down three things you are grateful for.", "Call a family member you haven't spoken to in a while.", "Listen to your favorite album from start to finish."];

        function saveKey() {
            const k = document.getElementById('userApiKey').value.trim();
            if(k.startsWith("AIza")) { localStorage.setItem('p!lot_key', k); geminiKey = k; alert("AI Activated!"); }
        }

        function refreshActivity() {
            document.getElementById('positiveActivity').innerText = activities[Math.floor(Math.random() * activities.length)];
        }
        refreshActivity();

        function signIn() { auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); }

        auth.onAuthStateChanged(u => {
            if(u) {
                document.getElementById('authArea').classList.add('hidden');
                document.getElementById('userInfo').classList.remove('hidden');
                document.getElementById('userName').innerText = u.displayName;
                document.getElementById('userAvatar').src = u.photoURL;
                loadPosts();
                updateMetricsUI();
            }
        });

        function switchTab(t) {
            document.getElementById('ai-tab').classList.toggle('hidden', t !== 'ai');
            document.getElementById('social-tab').classList.toggle('hidden', t !== 'social');
        }

        // ======= AI Counseling Logic =======
        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const msg = input.value.trim();
            if(!msg || !geminiKey) return;

            appendBubble(msg, 'user');
            input.value = "";

            const prompt = `You are a warm, empathetic AI counselor named P!LOT. 
            User State: ${JSON.stringify(mentalState)}. 
            User says: "${msg}". 
            Respond concisely in Traditional Chinese. 
            Include a JSON block at the end: {"metrics": {"anxiety": 0-10, "stress": 0-10, "depression": 0-10, "loneliness": 0-10, "award_delta": 1-20}}`;

            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${geminiKey}`, {
                    method: "POST", headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await res.json();
                const text = data.candidates[0].content.parts[0].text;
                
                const jsonMatch = text.match(/\{[\s\S]*"metrics"[\s\S]*\}/);
                if(jsonMatch) {
                    const m = JSON.parse(jsonMatch[0]).metrics;
                    Object.assign(mentalState, m);
                    mentalState.award += m.award_delta;
                    updateMetricsUI();
                }
                appendBubble(text.replace(jsonMatch, ""), 'ai');
                syncToAdmin(msg, "AI Chat");
            } catch (e) { appendBubble("System offline. Check API key.", 'ai'); }
        }

        function appendBubble(t, r) {
            const d = document.createElement('div'); d.className = `chat-bubble ${r}-bubble`; d.innerText = t;
            const w = document.getElementById('chatWindow'); w.appendChild(d); w.scrollTop = w.scrollHeight;
        }

        // ======= Social & Admin Sync =======
        function createPost() {
            const t = document.getElementById('postInput').value.trim();
            if(!t) return;
            db.collection("posts").add({
                uid: auth.currentUser.uid, name: auth.currentUser.displayName, 
                avatar: auth.currentUser.photoURL, content: t, timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            document.getElementById('postInput').value = "";
            syncToAdmin(t, "Social Post");
        }

        function loadPosts() {
            db.collection("posts").orderBy("timestamp", "desc").onSnapshot(snap => {
                const f = document.getElementById('socialFeed'); f.innerHTML = "";
                snap.forEach(doc => {
                    const d = doc.data();
                    f.innerHTML += `<div class="p-6 bg-white rounded-3xl border shadow-sm">
                        <div class="flex items-center gap-2 mb-2"><img src="${d.avatar}" class="w-6 h-6 rounded-full"><span class="font-bold text-xs">${d.name}</span></div>
                        <p class="text-sm text-slate-500">${d.content}</p>
                    </div>`;
                });
            });
        }

        function syncToAdmin(m, type) {
            if(!auth.currentUser) return;
            db.collection("monitor_center").doc(auth.currentUser.uid).set({
                name: auth.currentUser.displayName, avatar: auth.currentUser.photoURL,
                ...mentalState, last_msg: m, type: type, timestamp: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true });
        }

        function updateMetricsUI() {
            document.getElementById('stat-award').innerText = mentalState.award;
            const render = (id, label, val, color) => {
                document.getElementById(id).innerHTML = `<div class="flex justify-between text-[9px] font-black mb-1 opacity-40"><span>${label}</span><span>${val}/10</span></div>
                <div class="w-full bg-slate-100 h-1.5 rounded-full"><div class="h-full ${color} rounded-full transition-all duration-1000" style="width: ${val*10}%"></div></div>`;
            };
            render('m-anxiety', 'ANXIETY', mentalState.anxiety, 'bg-blue-400');
            render('m-stress', 'STRESS', mentalState.stress, 'bg-orange-400');
            render('m-depression', 'DEPRESSION', mentalState.depression, 'bg-purple-400');
            render('m-loneliness', 'LONELINESS', mentalState.loneliness, 'bg-teal-400');
        }
    </script>
</body>
</html>
