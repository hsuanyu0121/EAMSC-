<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P!LOT | Mental Health Navigator</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #FDFCFB; color: #4A443F; }
        .glass-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border-radius: 2rem; border: 1px solid rgba(107, 142, 35, 0.05); }
        .chat-bubble { max-width: 80%; padding: 1.25rem; border-radius: 1.5rem; margin-bottom: 1rem; line-height: 1.6; font-size: 14px; }
        .ai-bubble { background: #F0EBE3; align-self: flex-start; border-bottom-left-radius: 4px; }
        .user-bubble { background: #6B8E23; color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #E5E1DA; border-radius: 10px; }
    </style>
</head>
<body class="flex h-screen overflow-hidden">

    <aside class="w-80 bg-[#F5F2ED] p-6 flex flex-col border-r border-slate-200">
        <h1 class="text-4xl font-black italic text-[#6B8E23] mb-8 tracking-tighter">P!LOT</h1>
        
        <div id="authArea" class="mb-8">
            <button onclick="signIn()" class="w-full py-3 bg-white rounded-2xl shadow-sm font-bold text-slate-600 hover:bg-slate-50 transition">Google Sign In</button>
            <div id="userInfo" class="hidden flex items-center gap-3 p-3 glass-card bg-white/50">
                <img id="userAvatar" class="w-10 h-10 rounded-full border-2 border-white" src="">
                <span id="userName" class="text-sm font-bold truncate"></span>
            </div>
        </div>

        <nav class="space-y-2 flex-1">
            <button onclick="switchTab('ai')" id="tabBtn-ai" class="w-full text-left px-5 py-4 rounded-xl font-bold text-sm bg-white shadow-sm text-[#6B8E23]">ü§ñ AI Counseling</button>
            <button onclick="switchTab('social')" id="tabBtn-social" class="w-full text-left px-5 py-4 rounded-xl font-bold text-sm hover:bg-white/50 transition">üçÉ Social Square</button>
        </nav>

        <div class="mt-4 p-5 bg-[#A4C639]/10 rounded-3xl border border-[#A4C639]/20 shadow-sm">
            <p class="text-[10px] font-black text-[#55721C] uppercase mb-2">‚ú® Daily Mission</p>
            <p id="missionText" class="text-xs font-bold text-slate-600 leading-relaxed italic mb-4">Loading mission...</p>
            <div id="missionControl">
                <button id="completeBtn" onclick="completeMission()" class="w-full py-2 bg-[#6B8E23] text-white text-[10px] font-black rounded-full hover:bg-[#55721C] transition shadow-md">Mark as Completed</button>
                <button onclick="refreshMission()" class="w-full mt-2 text-[9px] font-bold text-slate-400 underline">Get New Mission</button>
            </div>
        </div>
    </aside>

    <main class="flex-1 p-8 flex flex-col relative bg-white overflow-hidden">
        
        <div id="ai-view" class="h-full flex flex-col">
            <div id="chatWindow" class="flex-1 overflow-y-auto flex flex-col pr-4">
                <div class="chat-bubble ai-bubble font-bold text-[#6B8E23]">Hello, I am P!LOT. I'm here to listen. How was your day?</div>
            </div>
            <div class="flex gap-2 mt-4">
                <input id="chatInput" type="text" class="flex-1 p-5 glass-card shadow-lg outline-none" placeholder="Type your thoughts here..." onkeypress="if(event.keyCode==13) sendMessage()">
                <button id="sendBtn" onclick="sendMessage()" class="px-8 bg-[#6B8E23] text-white rounded-full font-bold shadow-lg transition">Send</button>
            </div>
        </div>

        <div id="social-view" class="h-full flex flex-col hidden overflow-hidden">
            <h2 class="text-3xl font-black mb-6 italic text-slate-700">Social Square</h2>
            <div class="glass-card p-6 mb-6 bg-slate-50/50">
                <textarea id="postInput" class="w-full bg-transparent text-sm outline-none border-none resize-none" rows="3" placeholder="Share a supportive thought with the community..."></textarea>
                <div class="flex justify-end mt-2">
                    <button onclick="createPost()" class="px-8 py-2.5 bg-[#6B8E23] text-white rounded-full font-bold text-xs shadow-md active:scale-95 transition">Post to Square</button>
                </div>
            </div>
            <div id="socialFeed" class="flex-1 overflow-y-auto space-y-4 pr-2">
                </div>
        </div>
    </main>

    <aside class="w-72 p-8 flex flex-col items-center bg-[#FDFCFB] border-l border-slate-100">
        <h4 class="text-[10px] font-black opacity-30 uppercase tracking-[0.3em] mb-12 text-center">Navigator Progress</h4>
        <div class="p-10 bg-white rounded-[3rem] text-center shadow-2xl border border-slate-50 w-full relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1 bg-[#A4C639]"></div>
            <p class="text-[10px] font-black text-blue-500 mb-1 uppercase tracking-widest">Energy Score</p>
            <p id="stat-award" class="text-6xl font-black text-[#6B8E23]">500</p>
            <p class="text-[10px] mt-6 text-slate-400 font-bold leading-relaxed italic">Your actions today contribute to your personal growth.</p>
        </div>
    </aside>

    <script>
        // ======= [1] Firebase Config =======
        const firebaseConfig = {
            apiKey: "AIzaSyCYXhTT_MzhE6K2OE6HuAx9kwEZlIKbZMg",
            authDomain: "eamsc-929aa.firebaseapp.com",
            projectId: "eamsc-929aa",
            storageBucket: "eamsc-929aa.firebasestorage.app",
            messagingSenderId: "1010678005753",
            appId: "1:1010678005753:web:6283391cec141c7e664728",
            measurementId: "G-TQ48PSK5H4"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore(), auth = firebase.auth();

        // ======= [2] Gemini Settings (Paste your Key here) =======
        const GEMINI_API_KEY = "YOUR_GEMINI_API_KEY_HERE";

        let mentalState = { anxiety: 3, stress: 3, depression: 2, loneliness: 2, award: 500 };
        let currentMission = { text: "", completed: false };
        const missionPool = ["Invite a friend for dinner.", "Walk in a park for 15 minutes.", "Write 3 things you're grateful for.", "Call a family member.", "Listen to a full album.", "Tidy your desk."];

        // ======= [3] Tabs & UI =======
        function switchTab(t) {
            document.getElementById('ai-view').classList.toggle('hidden', t !== 'ai');
            document.getElementById('social-view').classList.toggle('hidden', t !== 'social');
            
            // UI Button Highlight
            document.getElementById('tabBtn-ai').className = t === 'ai' ? "w-full text-left px-5 py-4 rounded-xl font-bold text-sm bg-white shadow-sm text-[#6B8E23]" : "w-full text-left px-5 py-4 rounded-xl font-bold text-sm hover:bg-white/50 transition text-slate-500";
            document.getElementById('tabBtn-social').className = t === 'social' ? "w-full text-left px-5 py-4 rounded-xl font-bold text-sm bg-white shadow-sm text-[#6B8E23]" : "w-full text-left px-5 py-4 rounded-xl font-bold text-sm hover:bg-white/50 transition text-slate-500";
        }

        function refreshMission() {
            currentMission.text = missionPool[Math.floor(Math.random() * missionPool.length)];
            currentMission.completed = false;
            document.getElementById('missionText').innerText = currentMission.text;
            const btn = document.getElementById('completeBtn');
            btn.innerText = "Mark as Completed";
            btn.disabled = false;
            btn.className = "w-full py-2 bg-[#6B8E23] text-white text-[10px] font-black rounded-full transition shadow-md";
            syncToAdmin("Mission Updated", "STATUS");
        }

        function completeMission() {
            if(currentMission.completed) return;
            currentMission.completed = true;
            mentalState.stress = Math.max(0, mentalState.stress - 2);
            mentalState.award += 50;
            document.getElementById('stat-award').innerText = mentalState.award;
            
            const btn = document.getElementById('completeBtn');
            btn.innerText = "‚úÖ Mission Accomplished";
            btn.disabled = true;
            btn.className = "w-full py-2 bg-slate-200 text-slate-400 text-[10px] font-black rounded-full cursor-not-allowed";
            syncToAdmin(`Mission Done: ${currentMission.text}`, "MISSION");
        }

        // ======= [4] Core AI Logic =======
        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const msg = input.value.trim();
            if(!msg || !GEMINI_API_KEY) return;

            appendBubble(msg, 'user');
            input.value = "";

            const prompt = `You are P!LOT, a psychological counselor. Respond in English with empathy. 
            User state: ${JSON.stringify(mentalState)}. User Input: "${msg}". 
            End with JSON block: {"metrics": {"anxiety": 0-10, "stress": 0-10, "depression": 0-10, "loneliness": 0-10, "award_delta": 5-30}}`;

            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await res.json();
                const fullText = data.candidates[0].content.parts[0].text;
                const jsonMatch = fullText.match(/\{[\s\S]*"metrics"[\s\S]*\}/);
                
                if(jsonMatch) {
                    const m = JSON.parse(jsonMatch[0]).metrics;
                    Object.assign(mentalState, m);
                    mentalState.award += m.award_delta;
                    document.getElementById('stat-award').innerText = mentalState.award;
                }
                appendBubble(fullText.replace(/\{[\s\S]*\}/, "").trim(), 'ai');
                syncToAdmin(msg, "AI_CHAT");
            } catch (e) {
                appendBubble("Error connecting to AI. Please check settings.", 'ai');
            }
        }

        // ======= [5] Social Square & Sync =======
        function createPost() {
            const input = document.getElementById('postInput');
            const content = input.value.trim();
            if(!content || !auth.currentUser) return;

            db.collection("posts").add({
                name: auth.currentUser.displayName,
                avatar: auth.currentUser.photoURL,
                content: content,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            input.value = "";
            syncToAdmin(content, "SOCIAL");
        }

        function loadPosts() {
            db.collection("posts").orderBy("timestamp", "desc").onSnapshot(snap => {
                const feed = document.getElementById('socialFeed');
                feed.innerHTML = "";
                snap.forEach(doc => {
                    const p = doc.data();
                    feed.innerHTML += `
                        <div class="p-6 bg-slate-50 rounded-3xl border border-slate-100 shadow-sm animate-in fade-in duration-500">
                            <div class="flex items-center gap-2 mb-3">
                                <img src="${p.avatar}" class="w-7 h-7 rounded-full shadow-sm">
                                <span class="font-bold text-xs text-slate-700">${p.name}</span>
                            </div>
                            <p class="text-sm text-slate-500 leading-relaxed">${p.content}</p>
                        </div>`;
                });
            });
        }

        function syncToAdmin(msg, type) {
            if(!auth.currentUser) return;
            db.collection("monitor_center").doc(auth.currentUser.uid).set({
                name: auth.currentUser.displayName,
                avatar: auth.currentUser.photoURL,
                ...mentalState,
                mission: currentMission.text,
                mission_status: currentMission.completed ? "COMPLETED" : "ACTIVE",
                last_msg: msg,
                msg_type: type,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true });
        }

        function appendBubble(text, role) {
            const win = document.getElementById('chatWindow');
            const div = document.createElement('div');
            div.className = `chat-bubble ${role}-bubble shadow-sm`;
            div.innerHTML = marked.parse(text);
            win.appendChild(div);
            win.scrollTop = win.scrollHeight;
        }

        function signIn() { auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); }

        auth.onAuthStateChanged(u => {
            if(u) {
                document.getElementById('authArea').classList.add('hidden');
                document.getElementById('userInfo').classList.remove('hidden');
                document.getElementById('userName').innerText = u.displayName;
                document.getElementById('userAvatar').src = u.photoURL;
                loadPosts();
            }
        });

        refreshMission();
    </script>
</body>
</html>
